# Aliexpress_Drone_controller

# MINE VESPER - Custom Drone Controller

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

中国製激安ドローン（GT3）の通信プロトコルをリバースエンジニアリングし、ESP32ベースのカスタムコントローラーを開発したプロジェクトです。


## 📖 概要

このプロジェクトは、Aliexpressで約3000円で販売されている2.4GHz帯ドローンの通信プロトコルを解析し、専用のハードウェアコントローラーを自作したものです。約3ヶ月にわたる試行錯誤の末、WiFi（802.11）上のUDP通信で123バイトのパケットを送信する独自プロトコルを解明しました。

### 主な特徴

- **完全なプロトコル実装**: リバースエンジニアリングにより解明した123バイトパケットを完全再現
- **リアルタイム制御**: 80Hz（約13ms間隔）での高速パケット送信
- **直感的な操作**: ALPS製2軸アナログジョイスティックによる滑らかな制御
- **視認性の高いUI**: SSD1306 OLEDディスプレイでリアルタイム表示
- **低コスト**: 総製作コスト約2000円（基板製造費込み）

## 🎥 デモ

詳細な解析プロセスとデモ動画は、[ブログ記事](https://qurest.vercel.app/blog/2025-09-21-2-4Ghz-hacking)をご覧ください。

## 🛠️ ハードウェア

### 必要な部品

| 部品 | 型番/仕様 | 数量 | 参考価格 |
|------|-----------|------|----------|
| マイコンモジュール | ESP32-WROOM-32D | 1 | 約1,500円 |
| アナログジョイスティック | ALPS RKJXV1224005 | 1 | 約800円 |
| OLEDディスプレイ | SSD1306 (128×64, I2C) | 1 | 約500円 |
| タクトスイッチ | 6mm 4ピン | 5 | 約50円 |
| 抵抗 | 10kΩ | 4 | 約20円 |
| PCB | - | 1 | 約500円 |

**合計**: 約2,000円（基板製造費込み）

### 基板設計

PCB設計ファイルは`/hardware`ディレクトリに格納されています。

- **設計ツール**: KiCad
- **基板サイズ**: コンパクト設計（ポケットサイズ）
- **実装方式**: スルーホール実装（はんだ付け難易度: 低）
- **推奨製造業者**: JLCPCB, PCBWay, Elecrow など

## 💻 ファームウェア

### 環境構築

1. **Arduino IDEのインストール**
   - [Arduino IDE](https://www.arduino.cc/en/software)をダウンロード
   - ESP32ボードマネージャーをインストール
     - ファイル → 環境設定 → 追加のボードマネージャのURL:
```
     https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
```

2. **必要なライブラリのインストール**
   - Adafruit GFX Library
   - Adafruit SSD1306
   - WiFi (ESP32標準)
   - WiFiUdp (ESP32標準)

### ファームウェアの書き込み

1. リポジトリをクローン
```bash
   git clone https://github.com/yourusername/MINE-VESPER.git
   cd MINE-VESPER
```

2. Arduino IDEで`firmware/MINE_VESPER.ino`を開く

3. ボード設定
   - ボード: "ESP32 Dev Module"
   - Upload Speed: "115200"
   - Flash Frequency: "80MHz"

4. シリアルポートを選択して書き込み

### 主な機能

- **WiFiスキャン**: 起動時に周辺のアクセスポイントを自動スキャン
- **AP接続**: ボタン操作でドローンのAPを選択・接続
- **制御モード**: 
  - ロール/ピッチ/スロットル/ヨーの連続制御
  - 離陸/着陸コマンド
  - ジャイロキャリブレーション
  - ヘッドレスモード切替
- **リアルタイム表示**: 制御値、ADC値、接続状態を表示

### カスタマイズ可能なパラメータ

`firmware/MINE_VESPER.ino`内で以下のパラメータを調整できます。
```cpp
// ジョイスティックの感度
#define JOYSTICK_EMA_ALPHA 1.0        // 1.0 = ピーキー, 0.3 = スムーズ

// 制御の平滑化
#define CONTROL_SMOOTH_ALPHA 1.0      // 1.0 = 即応性高, 0.5 = 安定性高

// デッドゾーン
#define STICK_DEADZONE 100            // 中央付近の不感帯

// Expoカーブ
#define STICK_EXPO 0.0                // 0.0 = リニア, 0.5 = 中央付近が敏感

// 送信レート
#define CONTROL_INTERVAL 13           // ms (約80Hz)
```

## 📡 通信プロトコル

### 概要

- **プロトコル**: UDP over WiFi (802.11)
- **ポート番号**: 8800
- **IPアドレス**: 192.168.169.1（ドローン固定IP）
- **送信方式**: Fire-and-Forget（一方向送信）
- **送信レート**: 80Hz（約13ms間隔）

### パケット構造（123バイト）

パケットは6つのブロックで構成されています。
```
[ヘッダー 12B] [カウンター1 8B] [制御データ 16B] [チェックサム 51B] [カウンター2 20B] [カウンター3 16B]
```

#### ブロック3: 制御データ（最重要）

| オフセット | 名前 | 範囲 | 説明 |
|-----------|------|------|------|
| 0 | Roll | 40-220 | ロール（左右傾き）、中央値: 128 |
| 1 | Pitch | 40-220 | ピッチ（前後傾き）、中央値: 128 |
| 2 | Throttle | 40-220 | スロットル（上昇/下降）、中央値: 128 |
| 3 | Yaw | 40-220 | ヨー（回転）、中央値: 128 |
| 4 | Command | 0x00-0x04 | コマンドバイト（下表参照） |
| 5 | Headless | 0x02/0x03 | ヘッドレスモード (OFF: 0x02, ON: 0x03) |

#### コマンド一覧

| 値 | コマンド | 説明 |
|----|----------|------|
| 0x00 | NEUTRAL | 待機状態（常時送信） |
| 0x01 | TAKEOFF | 離陸 |
| 0x02 | LAND | 着陸/緊急停止 |
| 0x04 | CALIBRATE | ジャイロキャリブレーション |

詳細なパケット構造は[プロトコルドキュメント](docs/protocol.md)を参照してください。

## 🔧 組み立て手順

1. **PCB発注**
   - `/hardware/gerber`をZIP圧縮してJLCPCBなどに発注
   - 推奨オプション: 紫色、1.6mm厚

2. **部品実装**
   - スルーホール部品を順番にはんだ付け
   - **重要**: SSD1306の裏面に帯電防止テープを貼る

3. **ファームウェア書き込み**
   - ESP32にUSB接続してファームウェアを書き込み

4. **動作確認**
   - 電源投入 → WiFiスキャン → ドローンAP接続 → 制御テスト

詳細な組み立てガイドは[こちら](docs/assembly.md)。

## 📝 使い方

1. **起動**
   - コントローラーに電源を投入
   - 自動的にWiFiスキャンが開始されます

2. **接続**
   - 上下ボタンでドローンのAPを選択
   - 決定ボタン（中央）で接続

3. **操縦**
   - 左スティック: スロットル（上下）、ヨー（左右）
   - 右スティック: ピッチ（上下）、ロール（左右）
   - 上ボタン: 離陸
   - 下ボタン: 着陸
   - 左ボタン: ヘッドレスモード切替
   - 中央ボタン: ジャイロキャリブレーション

## 🚀 今後の拡張案

- [ ] リチウムバッテリー内蔵でポータブル化
- [ ] 録画機能の実装
- [ ] FPV（First Person View）対応
- [ ] 3Dプリントケースの設計
- [ ] Bluetoothゲームパッド対応
- [ ] テレメトリーデータ受信機能

## ⚠️ 免責事項

- このプロジェクトは教育・研究目的です
- ドローンの飛行は各国の法規制に従ってください
- リバースエンジニアリングは個人使用の範囲で行ってください
- プロジェクトの使用により生じた損害について、作者は一切の責任を負いません
- 安全な場所でテストを行い、事故には十分注意してください

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は[LICENSE](LICENSE)ファイルを参照してください。

## 🙏 謝辞

- [cifertech氏](https://cifertech.net/) - nRF24L01スキャナーのガイド
- [atomic14氏](https://github.com/atomic14/basic-esp32s3-dev-board) - ESP32-S3基板設計の参考
- Adafruit - 優れたライブラリ群
- KiCad - 素晴らしいEDAツール

## 📚 参考資料

- [詳細なブログ記事](https://qurest.vercel.app/blog/2025-09-21-2-4Ghz-hacking) - 解析プロセスの全記録
- [プロトコル仕様](docs/protocol.md) - 通信プロトコルの詳細
- [組み立てガイド](docs/assembly.md) - ステップバイステップガイド

## 🤝 コントリビューション

プルリクエストを歓迎します！大きな変更の場合は、まずissueを開いて変更内容を議論してください。

## 📧 コンタクト

質問や提案がある場合は、[Issue](https://github.com/yourusername/MINE-VESPER/issues)を開くか、[ブログ](https://qurest.vercel.app/)のコメント欄でお知らせください。

---

**MINE VESPER** - Made with ❤️ by Waka
